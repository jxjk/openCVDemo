# DWG自动测量功能使用指南

## 概述

本系统现已支持基于DWG/DXF图纸的自动测量功能，可以自动解析图纸标注、配准图像、执行测量并生成报告。

## 功能特性

### 1. DWG/DXF文件支持
- ✅ 自动将DWG转换为DXF格式（需要ODA File Converter）
- ✅ 直接导入DXF文件
- ✅ 自动提取尺寸标注信息
- ✅ 自动生成检测模板

### 2. 图像配准
- ✅ 支持多种特征检测方法（ORB、SIFT、SURF、AKAZE）
- ✅ 支持多种变换方法（单应性、仿射、相似、平移）
- ✅ 自动计算变换矩阵
- ✅ 提供配准置信度评估

### 3. 自动测量
- ✅ 基于图纸标注自动测量
- ✅ 支持圆形、线段等几何特征
- ✅ 自动计算偏差和合格性
- ✅ 生成详细测量报告

### 4. 图形界面
- ✅ 直观的操作流程
- ✅ 实时进度显示
- ✅ 可视化配准结果
- ✅ 测量结果表格展示

## 快速开始

### 1. 环境准备

确保已安装所有依赖：
```bash
pip install -r requirements.txt
```

### 2. 启动GUI

```bash
python dwg_auto_measurement_gui.py
```

### 3. 使用流程

#### 步骤1：加载图纸
1. 点击"浏览..."按钮选择DWG或DXF文件
2. 点击"1. 加载图纸"按钮
3. 系统自动解析图纸并显示

#### 步骤2：加载图像
1. 点击"浏览..."按钮选择待测量的图像文件
2. 点击"2. 加载图像"按钮
3. 图像显示在预览区域

#### 步骤3：图像配准
1. 选择配准方法（推荐使用单应性homography）
2. 选择特征检测方法（推荐使用ORB）
3. 点击"3. 图像配准"按钮
4. 系统自动执行配准并显示匹配结果

#### 步骤4：自动测量
1. 点击"4. 自动测量"按钮
2. 系统自动执行测量
3. 查看测量结果表格

#### 步骤5：导出报告
1. 点击"导出报告"按钮
2. 选择输出目录
3. 系统生成JSON和文本格式的报告

## 命令行使用

### DWG转换

转换单个文件：
```bash
python dwg_converter.py input.dwg output.dxf
```

批量转换：
```bash
python dwg_converter.py --batch ./input_dir ./output_dir
```

### 图像配准

```bash
python image_registration.py template.jpg image.jpg homography result.jpg
```

### 自动测量

```bash
python auto_measurement.py part.dwg part.jpg ./reports
```

## 工作原理

### 整体流程

```
DWG文件 → 转换为DXF → 解析标注 → 渲染图纸
                                        ↓
图像文件 ─────────────────────→ 图像配准 → 坐标转换
                                        ↓
                              自动测量 → 生成报告
```

### 详细步骤

1. **DWG转换**
   - 使用ODA File Converter将DWG转换为DXF
   - 如果转换器不可用，提示用户手动转换

2. **DXF解析**
   - 使用ezdxf库解析DXF文件
   - 提取几何实体和尺寸标注
   - 生成检测模板

3. **图纸渲染**
   - 将DXF渲染为图像
   - 使用matplotlib或简化渲染方法

4. **图像配准**
   - 检测特征点（ORB/SIFT/SURF/AKAZE）
   - 特征匹配
   - 计算变换矩阵
   - 评估配准质量

5. **自动测量**
   - 将标注坐标转换到图像坐标系
   - 在图像中执行测量
   - 计算偏差和合格性
   - 生成测量报告

## 测试

运行测试：
```bash
python tests/test_auto_measurement.py
```

或使用测试运行器：
```bash
python run_tests.py test_auto_measurement
```

## 常见问题

### Q1: DWG转换失败怎么办？

**A**: 检查以下几点：
1. 确保已安装ODA File Converter
2. 检查DWG文件是否损坏
3. 尝试手动将DWG转换为DXF（使用AutoCAD或在线工具）

### Q2: 图像配准失败怎么办？

**A**: 尝试以下方法：
1. 更换特征检测方法（SIFT通常效果更好）
2. 确保图纸和图像中有足够的特征点
3. 调整图像大小和分辨率
4. 检查光照条件是否一致

### Q3: 测量精度不满足要求？

**A**: 提高精度的方法：
1. 使用更高分辨率的图像
2. 进行像素-毫米标定
3. 启用亚像素检测
4. 改善光照条件
5. 使用远心镜头

### Q4: 如何处理不同的零件？

**A**: 每种零件需要：
1. 准备对应的DWG/DXF图纸
2. 图纸中包含完整的尺寸标注
3. 按照相同流程进行测量

### Q5: 能否批量测量？

**A**: 目前版本支持单次测量。批量功能可以通过以下方式实现：
1. 编写脚本循环调用auto_measure函数
2. 或在代码中实现批量处理逻辑

## 技术细节

### 支持的特征类型

- **圆形特征**: 直径测量
- **线段特征**: 长度测量
- **角度特征**: 角度测量（开发中）

### 配准方法

- **homography**: 单应性变换，适用于透视变换
- **affine**: 仿射变换，适用于平移、旋转、缩放
- **similarity**: 相似变换，适用于平移、旋转、等比缩放
- **translation**: 纯平移，适用于仅有位移的情况

### 特征检测方法

- **ORB**: 快速，不受专利限制，适合实时应用
- **SIFT**: 精度高，适用于复杂场景
- **SURF**: 速度快，精度高，但有专利限制
- **AKAZE**: 平衡速度和精度，不受专利限制

### 报告格式

**JSON格式**:
```json
{
  "template_name": "零件名称",
  "dwg_file": "零件.dwg",
  "image_file": "零件.jpg",
  "timestamp": "2026-02-22 12:00:00",
  "registration_success": true,
  "registration_confidence": 0.95,
  "total_features": 10,
  "measured_features": 10,
  "passed_features": 9,
  "failed_features": 1,
  "results": [...]
}
```

**文本格式**:
```
============================================================
自动测量报告
============================================================
模板名称: 零件名称
DWG文件: 零件.dwg
图像文件: 零件.jpg
时间戳: 2026-02-22 12:00:00
配准成功: 是
配准置信度: 0.95

总特征数: 10
已测量特征数: 10
合格特征数: 9
不合格特征数: 1
总耗时: 5.23秒
```

## 扩展开发

### 添加新的特征类型

1. 在`drawing_annotation.py`中添加新的标注类型
2. 在`auto_measurement.py`中实现测量逻辑
3. 在GUI中添加显示支持

### 添加新的配准方法

1. 在`image_registration.py`中实现新的变换计算
2. 在`_compute_transformation`方法中添加新方法
3. 在GUI中添加选项

### 集成到主系统

可以将DWG自动测量功能集成到主GUI (`inspection_gui_enhanced.py`) 中：

1. 在主菜单中添加"DWG自动测量"选项
2. 创建对话框或新页面
3. 调用`AutoMeasurementEngine`类

## 性能优化

### 提高配准速度

- 使用ORB特征检测器（最快）
- 减少图像分辨率
- 限制特征点数量

### 提高测量精度

- 使用SIFT特征检测器（最准确）
- 提高图像分辨率
- 使用亚像素检测

### 内存优化

- 及时释放临时图像
- 使用图像ROI而非全图处理
- 批量处理后清理缓存

## 参考资源

- OpenCV文档: https://docs.opencv.org/
- ezdxf文档: https://ezdxf.readthedocs.io/
- ODA File Converter: https://www.opendesign.com/guestfiles/oda_file_converter

## 更新日志

### V1.0 (2026-02-22)

**新增功能**:
- DWG/DXF文件导入和转换
- 自动标注提取
- 图像配准
- 自动测量
- 测量报告生成
- 图形界面

**支持功能**:
- 多种特征检测方法
- 多种变换方法
- 可视化配准结果
- 详细的测量报告

## 联系支持

如有问题或建议，请通过以下方式联系：
- 提交Issue到GitHub仓库
- 发送邮件到项目维护者

---

**文档版本**: V1.0
**最后更新**: 2026-02-22
**维护者**: 项目团队